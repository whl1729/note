# 编程沉思录

## linux 沉思录

自己平时主要使用linux系统来开发软件，渐渐体会到linux系统的一些设计哲学，因此记录下来，加以反思。

1. 使用linux系统下的所有工具，都应该先阅读其help文档。

2. 开发linux系统下的所有工具，都应该提供help文档。

## C1 项目沉思录

1. 开发项目时，必须明确项目所有的功能，以及它们之间的约束关系。在开发新功能时，要分析它与所有旧功能的约束关系。

2. 调用底层接口时，需要判断返回值并进行错误处理。同理，消息交互也需要考虑错误处理。

3. 不稳定的功能绝不能上线。（第一次试产停车监控功能受到一片批评）

4. 修改代码后必须重新自验。（重构代码后拍照功能出问题）

5. 一定要确保充足的测试时间。（v1.0.10版本ADAS失效检测功能只测试了一晚就上线，用户升级后发现有问题）

6. 修改代码时需要考虑与其他功能的约束关系。（v1.0.10版本关闭停车监控时忘记修改设置停车监控的代码，导致设置停车监控失败）

7. 修改“打开屏幕”功能引入严重bug，要深刻反思。

8. 定位问题一定要讲究思路，一定要想办法寻找线索。（tar解包速度慢的问题，最终发现是cpu exception导致系统挂死）

9. 分析清楚处理流程再编码，调用底层接口必须明确其约束条件。（GPS校时导致车辆卡死）

10. 接收信号时要确认或检验其可靠性。

11. 开发任何功能都必须自验。（发现自动清理视频封面功能有个删除数据库记录失败的bug，如果做了自验就能避免这个bug）

12. 写shell脚本时要注意工作目录、当前目录、检查执行结果。（发布v1.0.12升级脚本导致主机服务升级失败）

13. 编码时要考虑尽可能多的异常情况，比如：写文件时要考虑对应的目录是否存在。（设备运行后再插入存储卡进行升级会失败）

### 设计接口时要考虑清楚使用场景（被谁使用、什么时候使用、使用时要注意什么）、要健壮

前段时间在重构读写文件的接口时，引入了一个bug：我使用一个全局变量settingMutex指针来保证互斥读写，但在对外接口MutexRead和MutexWrite中直接使用该指针，没有先进行判空处理。导致开机启动时，如果处于缩时录影状态下，需要设置分辨率，进而需要读设备配置文件，而此时settingMutex还没初始化，导致访问空指针。纵观这个问题，根本原因在于设计MutexRead接口的不合理（没考虑到可能未初始化settingsMutex指针就被调用），直接原因是开机启动的处理流程混乱，没有做过良好的设计。

教训是：设计接口时要考虑清楚使用场景，要保证健壮性，做到不管怎么调用都不至于崩溃。
