# Minieye C1项目写过的bug

## 17 防碰设置频繁设置时部分失效

- 原因：与问题8如出一辙的错误。清理缓存时一把清完了，没考虑到可能还有没处理的配置项。
- 教训：
    - 设计阶段要考虑清楚，这本质上是个“生产者-消费者”问题，对共享内存一定要特别小心，避免没消费完就回收资源。
    - 自测时要覆盖各种场景。

## 16 手机APP进入“防碰设置”闪退

- 原因：编码时出现拼写错误，导致新生产的主机服务软件的ADAS配置文件中ldw speed的options字段错写为option，因此返回给app的配置文件中不含有options字段，导致APP闪退。自测时没验证生产场景。
- 教训：
    - 编码完成后，要仔细检视代码。
    - 自测前要写测试用例，写测试用例时要覆盖各种场景（比如生产场景）。

## 15 获取媒体列表时，同时传入order=asc和totalDuration参数会出错

- 原因：编码时没考虑清楚：order=asc 和 totalDuration 两个参数对排序的要求是相反的，前者要求升序，后者要求降序。而编码时忽略了 order=asc 对 totalDuration 的影响。另外，自己在自测时也忽略了其他参数（order）对新增参数（totalDuration）的影响，本质上是懒惰导致的，当时的心理活动大概是这样的——这个接口参数比较多，都测一遍会比较耗时，貌似旧参数对新增参数也没啥影响，就不考虑了。
- 教训：
    - 编码前，对每个修改点和功能点都考虑清楚，并写下实现思路。这点最关键，自己就是由于实现思路不够清晰，导致忽略了 “order 参数对 totalDuration 参数有影响”这个事实。
    - 自测时，要考虑清楚涉及的功能点和测试点。最好回顾一遍实现思路，分析其中是否有盲点。

## 14 重复计算日出日落时间

- 原因：编码时引入一个bug，计算完日出日落时间后没设置notified变量为true。由于这个bug可能带来性能问题，但不一定导致功能问题，导致测试时也没测出来。但如果观察CPU占用率应该也能发现异常。
- 教训：
    - 检视代码时，增加一个检查项：对每个新增的变量，都跟踪一遍其创建、更新流程，检查是否忘记更新等。
    - 自验时，要检查调试日志，看是否有异常打印。

## 13 拔卡时触发紧急碰撞没有告警

- 原因：一开始紧急碰撞是不播放告警声音的，后来增加告警声音时，修改代码时有个函数漏了改，导致出现bug。
- 教训：修改代码真的要如履薄冰、小心谨慎。修改前最好分析一遍代码，列出所有要修改的地方，改完后核对一遍。

## 12 目前已发现3个时区问题：时区错误后无法修正、频繁调用底层接口查询时区、早上5点无法切换白天模式

- 原因：
    - 时区错误后无法修正：开发时没考虑到这种场景，一般也不会发生“时区错误”的问题，导致一直没发现这个问题
    - 频繁调用底层接口查询时区：修改代码时没检查到对调用者的影响，调用底层接口时没留意是否存在频繁调用的可能，测试时没接串口也不容易发现这个问题
    - 早上5点无法切换白天模式：开发时没考虑到时间溢出的问题，测试时没测凌晨5点的场景——这是很不应该的！连设置项的边界点都没测试，实在无法原谅！
- 教训：
    - 对于参数设置功能，开发时要考虑所有设置该参数的场景，测试时也要覆盖所有设置该参数的场景。
    - 调用别人的接口时，要保持警惕：避免频繁调用。
    - 测试时要尽可能覆盖各种场景。

## 11 修改视频时长有误的问题后，开机后插卡多次播放开机声音

- 原因：修改代码时引入了一个全局变量，而代码中存在该变量未被初始化就被使用的场景，导致除0错误，进而引起程序重启。
- 教训：使用变量前确保已初始化；使用除法时一定要判断除数是否为0

## 10 修改IMU调校后ADAS告警失效

- 原因：修改代码时，没改完整。修改前已经意识到判断ADAS是否休眠的地方会影响到ADAS告警，但修改过程中还是忘记这个场景，并且测试用例也没覆盖ADAS告警场景。
- 教训：修改代码前，先梳理思路，把注意事项记录下来。修改代码后，一定要充分测试，覆盖尽可能多的测试场景。

## 9 新生产的设备无法进行手机授权

- 原因：新生产的设备中，主机程序没有配置文件，导致设备进行手机授权时失败。我没考虑到新生产的设备是没有任何主机服务的文件的，也没考虑到生产是直接拷贝我的数据包，而不是执行update.sh脚本。
- 教训：编程时要多思考并且考虑清楚用户使用场景、生产场景。提前进行测试，提前发现自己设计中考虑不周到的地方。

## 8 防碰设置只能设置一项

- 原因：目前防碰设置是异步处理的，其中一个goroutine会将用户输入的防碰设置会保存在全局数组G中，另一个goroutine会定时读取这个全局数组。问题在于我保存用户输入的防碰设置时，直接赋值给全局数组G，没考虑到全局数组G可能还含有尚未被读取的用户输入。以前在华为开发Saturn项目中也遇到过类似的bug：设置过滤规则时直接赋值给某个整型变量，而正确做法是应该使用与操作，避免覆盖其他bit。
- 教训：编程时要严谨，明确每行代码、每个变量的含义。要设计好各种测试场景、做好充分测试。

## 7 启动时如果处于缩时录影模式程序会崩溃

- 原因：启动时，如果处于缩时录影模式，处理流程中存在空指针错误，导致程序崩溃。
- 教训：所有使用指针的地方需要判空。任何处理流程都需要验证。

## 6 格式化存储卡或清空存储卡模块时会误删子相册目录

- 原因：开发清空存储卡模块时，只留意了auto_video/general_record相册，没验证其他相册；开发格式化存储卡时功能是ok的，后续修改了代码，没重新验证该功能，导致问题没暴露出来。
- 教训：修改代码时，要重新验证所有相关的功能。由于不易判断相关功能有哪些，每次修改代码尽量只改一个模块，尽量简短。

## 5 多台手机同时给一个设备上传固件时会失败

[redmine issue #5377](https://redmine.minieye.tech/issues/5377)

- 原因：没考虑到这种场景，这种场景本来就是不允许的，应该在程序中进行检查。
- 教训：开发接口时，要考虑到该接口的并发性和可重入性。

## 4 由于flash容量不足导致固件升级失败

[redmine issue #5459](https://redmine.minieye.tech/issues/5459)

- 原因：没注意一键升级脚本的工作目录，没细想整个升级流程，导致没发现执行自升级脚本时会将临时文件写到flash中。
- 教训：开发功能前，先分析清楚该功能的工作原理和执行流程，提取出约束条件，再进行编码。

## 3 APP进行画面调校时设备自动重启

[redmine issue #5560](https://redmine.minieye.tech/issues/5560)

- 原因：修改自动调节亮度功能时，异常分支没做sleep处理，导致疯狂创建进程和打印日志，进一步导致上传错误日志容量过大，耗尽系统内存。
- 教训：修改代码要小心谨慎，要充分自验。在嵌入式设备开发功能，需要考虑内存问题，严禁使用局部变量存储大量数据。

## 2 headway延时6秒才显示

[redmine issue #5320](https://redmine.minieye.tech/issues/5320)

- 原因：发送GPS速度给显示器时没检查发送频率，沿用了之前的频率。
- 教训：编码前先写文档，记录约束条件。

## 1 设备启动后插入新存储卡升级会失败

[redmine issue #5519](https://redmine.minieye.tech/issues/5519)

- 原因：保存文件时忘记检查目录是否存在
- 教训：同样的错误犯了两次。编码时要确认前提条件。
