# 计算机组成原理 FAQ

## Q1 2019/05/25 CPU是如何工作的？尤其是如何处理中断的？

### 问题详述

CPU在执行指令时，是如何保证它按照取指、译码、执行、访存、写回等步骤循环进行的？发生中断时，CPU需要与中断控制器交互，然后根据中断向量找到中断处理例程的入口，并且需要将ss/esp/eflags/cs/eip等压栈，还有判断是否切换特权级，这一系列复杂的操作，CPU是如何做到的？

### 思考过程

以下是我的思考过程，其中查阅的资料记录在[《计算机组成原理》学习笔记](learn_cod.md)

1. 这一系列复杂的操作，是否像软件那样已经编成一段指令，每次直接逐句执行？还是设计好硬件电路，直接提供输入数据及相关信号，就能完成类似中断处理这样的操作？

2. 不妨采用由简到繁的策略，首先分析CPU具有哪些功能、做了哪些事情，然后将这些功能按从简单到复杂的顺序排序，逐个分析。

3. CPU的功能用一句话概括就是：执行指令。包括中断处理，无非就是执行一条"INT n"的指令。那么，我要理解CPU的工作原理，只需理解CPU执行指令的原理。CPU执行指令一般分为5个步骤：取指、译码、执行、访存、写回。那么CPU是如何完成这5个步骤的呢？
    - 问：为什么CPU会周而复始地执行一条条指令？这个是如何设计的？
    - 答：应该是时钟芯片每个周期产生一个时钟信号，处理器本质上是由多个时序逻辑电路组成的，当收到时钟信号后就执行1次操作。
    - 问：如何保证CPU每次都是按照这个顺序执行5个步骤？
    - 答：CPU的物理电路是按照指令周期的5个阶段的顺序来连接的，上一个阶段的输出作为下一个阶段的输入，这就保证了各阶段之间的有序性。

4. 任何一条指令，都需要按照指令周期分解成取指、译码、执行、访存、写回等5个步骤。设计每条指令时都要分析它在这5个步骤中分别要做什么事情。CPU是靠硬件电路来自动执行每个指令的这5个步骤的。也就是说，当CPU读到一条指令，它就清楚每个步骤要怎么做了。比如读到"sub %eax, %ebx"（CPU看到的是二进制形式的机器指令，这里为了可读性用汇编指令表示），CPU就知道取指阶段只需将PC直接加4（不涉及跳转），译码阶段需要读%eax和%ebx寄存器的值，执行阶段需要将上一阶段读出的值相减并设置EFLAGS寄存器，访存阶段不需要干任何事情，写回阶段需要用相减的结果更新%ebx寄存器。

5. CPU的中断处理需要执行多件事情，具体是如何实现的？是不是有个中断处理例程总入口？答：x86处理器通过执行一个微码程序（microcode routine）来进行中断处理。

