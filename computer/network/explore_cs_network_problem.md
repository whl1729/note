# 探索TCP/IP 协议栈中各层之间的关系

进入公司后，我做的第一个项目是C1主机服务程序开发。C1主机需要与手机APP、显示器程序进行网络通信。在开发期间，曾经出现过不少网络通信问题，比如：

- APP上传文件时，C1主机提前返回错误并随后关闭连接，APP无法及时识别而报“broken pipe”。
- APP上传文件时突然断开与C1主机的wifi连接，C1主机需要等待较长时间才能和APP断开。
- C1主机发送安装包给显示器后，迟迟等不到显示器的回复。

在解决这些网络问题的过程中，我发现自己对于应用层与其他层的关系理解得有点模糊，影响了问题定位效率。为什么说影响问题定位效率呢？我们知道，定位问题的主要思路便是逐步缩小排查范围，对于服务端网络问题而言，便是要确认是应用层的问题（如代码有bug）还是底层的问题（如wifi异常断开）。只有理清应用层与其他层的关系，才可能快速找出问题根源。下面将展开讨论TCP/IP 协议栈中各层之间的关系。

## TCP/IP 协议栈各层的实现

在“计算机网络”课程中，我们学过TCP/IP五层协议，从上到下依次是：

- 应用层
- 传输层
- 网络层
- 数据链路层
- 物理层

倘若要讨论清楚TCP/IP 协议栈各层的具体实现细节，远非本人目前知识水平所能及。因此，这里只讨论两个简单、具体的问题，以对TCP/IP 协议栈有个基本的概念。（注意：为了简化问题，以下的讨论限制在**同一局域网内的两台设备之间直接通信**的场景，不涉及路由器、交换机等中间节点。）

1. TCP/IP 协议栈各层分别由谁实现？对应的实体是什么？
2. TCP/IP 协议栈各层之间是如何交互的？

### 问题1：TCP/IP 协议栈各层分别由谁实现？对应的实体是什么？

这个问题的后半部分听起来可能有点奇怪，这里澄清一下：TCP/IP 协议栈的实现，既需要硬件（网卡、网线、wifi芯片、交换机、路由器等），也需要软件（网卡驱动、操作系统、应用程序）。因此，我想搞清楚：TCP/IP 协议栈各层需要哪些硬件和软件？它们分别是由谁提供的？存在在哪里？

不妨看下TCP/IP协议栈各层在C1主机上分别是由谁实现的。应用层和物理层都比较容易理解：应用层是由C1主机服务程序实现的，而这个程序是由应用软件开发者提供的。物理层是由网卡实现的（C1主机与手机的wifi连接使用无线网卡，与显示器的连接使用USB虚拟网卡），而网卡是由硬件厂商提供的。那么中间三层呢？

根据维基百科对于[网卡（Network interface controller）](https://en.wikipedia.org/wiki/Network_interface_controller) 的描述："The NIC is both a **physical layer and data link layer** device, as it provides physical access to a networking medium and, for IEEE 802 and similar networks, provides a low-level addressing system through the use of MAC addresses that are uniquely assigned to network interfaces."，可以认为网卡和网卡驱动构成了物理层和数据链路层。网卡驱动有的是系统自带，有的需要从官方芯片厂商网站下载安装。那剩下来的传输层和网络层呢？

我们知道，传输层的主要协议是TCP和UDP，网络层的主要协议是IP，在《TCP/IP 详解 卷2：实现》的第1.7节“网络实现概述”中提到，内核中的联网代码组织成三层（如下图所示）：

- 插口层（socket layer）是一个到下面协议相关层的协议无关接口。所有系统调用从协议无关的插口层开始。
- 协议层（protocol layer）包括TCP/IP等协议族的实现。
- 接口层（interface layer）包括同网络设备通信的设备驱动程序。

![Net/3联网代码的大概组织](images/the_general_organization_of_networking_code_in_net_3.png)

可见，传输层和网络层是由操作系统内核实现的。基于以上分析，我们可以得出结论：TCP/IP 协议栈从上到下，分别由应用程序、操作系统内核、网卡驱动和网卡来实现。

### 问题2：TCP/IP 协议栈各层之间如何交互？

根据谢希仁所著《计算机网络》第1.7.2节的描述，分层的一个好处是：各层之间是独立的。某一层并不需要知道它的下一层是如何实现的，而仅仅需要知道该层通过层间的接口所提供的服务。接下来，我们同样不关心每一层是如何实现的，而关心每一层是如何向上一层提供服务，以及每一层是如何使用下一层的服务的。

#### 问题2.1：应用层与传输层是如何交互的？

《Unix 网络编程 卷1：套接字联网API》第2章的图2.5（如下图所示）展示了一个完整的TCP连接所发生的实际分组交换情况，图中也展示了相关的套接字API。据此我们可以知道，作为传输层的实现者，操作系统内核是通过API的方式向应用层提供传输层的服务的。比如，为从传输层收发数据，应用层的客户端只需调用socket/connect/read/write等函数，应用层的服务端只需调用socket/bind/listen/accept/read/write等函数。

![TCP连接的分组交换](images/package_switch_in_tcp_connection.png)

#### 问题2.2：传输层与网络层是如何交互的？

由于传输层与网络层均在操作系统内核中实现，可以想象两者也是通过函数调用的方式完成交互。要想了解两者具体的交互细节，需要啃内核代码。这里暂不讨论。

#### 问题2.3：网络层与数据链路层是如何交互的？

网络层是在操作系统内核实现的，而数据链路层是在网卡驱动实现的，那么它们之间是如何通信的呢？如何实现数据的收发？

#### 问题2.4：数据链路层与物理层是如何交互的？

## TCP/IP 协议栈各层的常见问题

- 服务器IP不可达
- 服务器端口不可达
- 客户端网络短暂断开
- 客户端网络长期断开
- 服务器网络短暂断开
- 服务器网络长期断开
- 客户端堵塞
- 服务端堵塞

## 关于网络通信的一些疑惑

1. 操作系统是如何向应用层的程序提供TCP/IP服务的？系统后台是否运行着一个TCP/IP协议栈进程？还是以系统调用的方式提供服务？

2. TCP/IP传输层、网络层、数据链路层又是如何实现的？各层是以进程的方式存在，还是接口的方式？

3. 应用层与tcp/ip协议栈的数据通信是怎样的？应用层如何从tcp/ip协议栈获取数据的？如何通知tcp/ip协议栈结束连接的？

4. 网卡与tcp层的交互是怎样的？tcp/ip协议栈如何从网络中获取数据包？中间设备驱动程序又做了什么工作？

5. 出现网络问题时，如何区分是TCP/IP协议族的问题，还是应用程序的问题？

### TCP/IP stack

1. TCP/IP stack 下接网卡驱动、软中断；上承 inode 转发来的系统调用操作；中间还要与平级的进程文件描述符管理子系统打交道。
