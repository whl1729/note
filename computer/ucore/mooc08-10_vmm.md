# 《Tsinghua oc mooc》第8~10讲 虚拟内存管理

## 资源

1. [OS2018Spring课程资料首页](http://os.cs.tsinghua.edu.cn/oscourse/OS2018spring)

2. [uCore OS在线实验指导书](https://chyyuu.gitbooks.io/ucore_os_docs/content/)

3. [ucore实验基准源代码](https://github.com/chyyuu/ucore_os_lab)

4. [MOOC OS习题集](https://xuyongjiande.gitbooks.io/os_exercises/content/index.html)

5. [OS课堂练习](https://chyyuu.gitbooks.io/os_course_exercises/content/)

6. [Piazza问答平台](https://piazza.com/connect) 暂时无法注册

## 第八讲 虚拟内存概念

1. 为什么需要虚拟内存：计算机系统时常出现内存空间不够用的情况，虚拟存储可以在有限容量的内存中，以页为单位自动装入更多更大的程序。

2. 解决内存空间不够用的三种技术：覆盖、交换和虚拟内存。

3. 覆盖
    - 目标：在较小的可用内存中运行较大的程序
    - 方法：依据程序逻辑结构，将程序划分为若干功能相对独立的模块；将不会同时执行的模块共享同一块内存区域
        - 必要部分（常用功能）的代码和数据常驻内存
        - 可选部分（不常用功能）放在其他程序模块中,只在需要用到时装入内存
        - 不存在调用关系的模块可相互覆盖，共用同一块内存区域

4. 交换
    - 目标：增加正在运行或需要运行的程序的内存
    - 方法：可将暂时不能运行的程序放到外存。
        - 换入换出的基本单位是整个进程的地址空间
        - 程序换入时的重定位：采用动态地址映射的方法，程序换出后再换入时不需要放在原处

5. 局部性原理
    - 时间局部性：一条指令的一次执行和下次执行，一个数据的一次访问和下次访问都集中在一个较短时期内
    - 空间局部性：当前指令和邻近的几条指令，当前访问的数据和邻近的几个数据都集中在一个较小区域内
    - 分支局部性：一条跳转指令的两次执行，很可能跳到相同的内存位置。
    - 局部性原理的意义：从理论上来说，虚拟存储技术是能够实现的，而且可取得满意的效果
    - 利用局部性原理提高程序性能：比如按行遍历数组

6. 虚拟存储的目标
    - 只把部分程序放到内存中，从而运行比物理内存大的程序。由操作系统自动完成，无需程序员的干涉。
    - 实现进程在内存与外存之间的交换，从而获得更多的空闲内存空间。在内存和外存之间只交换进程的部分内容。
    
7. 虚拟存储的原理
    - 装载程序时，只将当前指令执行需要的部分页面或段装入内存
    - 指令执行中需要的指令或数据不在内存（称为缺页或缺段）时，处理器通知操作系统将相应的页面或段调入内存
    - 操作系统将内存中暂时不用的页面或段保存到外存
    - 从技术上来看，硬件提供页式或短时存储中的地址转换机制，操作系统管理内存和外存间页面或段的换入和换出

8. 虚拟存储的基本特征
    - 不连续性：物理内存分配非连续、虚拟地址空间使用非连续
    - 大用户空间： 提供给用户的虚拟内存可大于实际的物理内存
    - 部分交换： 虚拟存储只对部分虚拟地址空间进行调入和调出

9. 虚拟页式存储管理：在页式存储管理的基础上，增加请求调页和页面置换
    - 当用户程序要装载到内存运行时，只装入部分页面，就启动程序运行
    - 进程在运行中发现有需要的代码或数据不在内存时，则向系统发出缺页异常请求
    - 操作系统在处理缺页异常时，将外存中相应的页面调入内存，使得进程能继续运行

10. 虚拟页式存储管理中的页表项结构
    - 驻留位：表示该页是否在内存。1表示该页位于内存中，该页表项是有效的，可以使用；0表示该页当前在外存中，访问该页表项将导致缺页异常
    - 修改位：表示在内存中的该页是否被修改过。回收该物理页面时，据此判断是否要把它的内容写回外存。
    - 访问位：表示该页面是否被访问过（读或写）。用于页面置换算法。
    - 保护位：表示该页的允许访问方式。只读、可读写、可执行等。

11. 缺页异常的处理过程
    - A. 在内存中有空闲物理页面时，分配一物理页帧f，转第E步
    - B. 依据页面置换算法选择将被替换的物理页帧f，对应逻辑页q
    - C. 如q被修改过，则把它写回外存
    - D. 修改q的页表项中驻留位置为0
    - E. 将需要访问的页p装入到物理页面f
    - F. 修改p的页表项驻留位为1,物理页帧号为f
    - G. 重新执行产生缺页的指令

12. 虚拟页式存储中的外存管理
    - 在何处保存未被映射的页？为了能方便地找到在外存中的页面内容，一般放在交换空间（磁盘或者文件），采用特殊格式存储未被映射的页面
    - 虚拟页式存储中的外存选择
        - 代码段：可执行二进制文件
        - 动态加载的共享库程序段：动态调用的库文件
        - 其它段：交换空间

13. 虚拟页式存储性能度量：有效存储访问时间（effective memory access time, EAT） 
    - EAT = t0 - (1 - p) + t1 - p - (1 + q)
    - 缺页率p
    - 页修改概率q
    - 访存时间t0
    - 缺页异常处理时间t1（或者叫磁盘访问时间）

## 第九讲 页面置换算法

1. 页面置换算法的功能、目标和页面锁定
    - 页面锁定（frame locking）：描述必须常驻内存的逻辑页面，使用页面中的锁定标志来实现。

2. 页面置换算法的分类
    - 局部
    - 全局

3. 最优算法：将未来最迟访问的页面换出

4. 先进先出算法（FIFO）：将在内存中驻留时间最长的页面换出
    - Belady现象：进程分配物理页面数增加时，缺页并不一定减少。（Belady现象：何时有？何时没有？）

5. 最近最久未被引用算法（LRU）：将最长时间没有被引用的页面换出

6. 时钟置换算法（Clock）：LRU和FIFO的折中，将访问位为0的页面换出

7. 最不常用算法（LFU）：将访问次数最少的页面换出

5. 常驻集：不理解
