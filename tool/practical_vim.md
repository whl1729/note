# 《Vim实用技巧》

## 1 Vim解决问题的方式

### 技巧1 .命令

1. .命令可以让我们重复上次的修改，它是Vim中最为强大的多面手。所谓上次的修改，可以指很多东西，一次修改的单位可以是字符、整行甚至整个文件。

2. 每次我们进行插入模式时，也会形成一次修改。从进入插入模式的那一刻起，直到返回普通模式时为止，Vim会记录每一个按键操作。做出这样一个修改后再用.命令的话，它将会重新执行所有这些按键操作。

3. Vim可以录制任意数目的按键操作，然后在以后重复执行它们。这让我们可以把最常重复的工作流程录制下来，并用一个按键重放它们。我们可以把.命令当成一个很小的宏。

### 技巧2 不要自我重复

1. 对于在行尾添加内容这样的常见操作，Vim提供了一个专门的复合命令`A`，可以把两步操作合并为一步。我们应该使用这样的复合命令，来减少无关的移动。
```
A;<ESC>
j.
```

2. Vim的很多单键命令都可以被看成两个或多个其他命令的组合。
    - C: c$
    - s: cl
    - S: ^c
    - I: ^i
    - A: $a
    - o: A<CR>
    - O: ko

### 技巧3 以退为进

1. 为了在一个字符前后各添加一个空格，我们先后退一步，然后前进三步。这样做的好处是我们可以用.命令来重复这一修改。
```
f+
s<br>+<br><ESC>
;.
```

### 技巧6 一键移动，另一键执行

1. 查找并手动替换单词
```
/word
cw(new_word)
 n.
```

## 2 模式

### 技巧7 停顿时请移开画笔

1. 普通模式是Vim的自然放松状态。

2. 普通模式的强大，很大程度上源于它可以把操作符与动作命令结合在一起。

### 技巧8 把撤销单元切成块

1. 我喜欢让每个“可撤销块”对应一次思考过程。我经常在每句话的结尾停顿一些，想一想接下来该写什么。不管停顿的时间有多短，每次停顿都是一个自然的中断点，提示我该退出插入模式了。

### 技巧9 构造可重复的修改

1. 假设光标位于一个单词的中间位置，而我们想删除这个单词，最好的方法是`daw`(delete a word)。因为这时如果我们使用.命令，它会重复删除上次删除单词的命令。

### 技巧10 用次数做简单的算术运算

1. `<Ctrl-a>`和`<Ctrl-x>`分别对数字执行自加和自减操作，默认是加1或减1。如果带一个次数前缀，就可以用它们加减任意整数。

2. vim把以0开头的数字解释为八进制值（单个0还是会解释为十进制的0），因此对007执行`<Ctrl-a>`命令得到的是010. 你可以在vimrc中加入`set nrformats`，这会让vim把所有数字都当成十进制。

### 技巧12 操作符 + 动作命令 = 操作

1. 一个操作由一个操作符后跟一个动作命令组成。比如`d{motion}`命令可以对一个字符（dl）、一个完整单词（daw）或一整个段落（dap）进行操作，它作用的范围由动作命令决定。其中d是操作符，l、aw和ap是动作命令。

2. `g~`、`gu`和`gU`命令要用两次按键来调用，这里的g可以看做一个前缀字符，用来改变其后面的按键行为。

3. 当一个操作符被重复两次，则作用于当前行。
    - `dd` 删除当前行
    - `>>` 缩进当前行
    - `gUgU`或`gUU` 将当前行所有字符替换成大写

## 3 插入模式

### 技巧13 在插入模式下即时更正错误

1. 在插入模式下删除字符、单词或整行
    - `Ctrl-h` 删除前一个字符
    - `Ctrl-w` 删除前一个单词
    - `Ctrl-u` 删至行首
    
2. 这些命令不是插入模式所独有的，也不是vim所独有的，在vim的命令行模式中，以及在bash shell中，也可以使用它们。

### 技巧14 返回普通模式

1. `<Ctrl-[>` 也可以切换到普通模式

### 技巧15 在插入模式下粘贴寄存器中的文本

1. `<Ctrl-r>0` 把刚才复制的文本粘贴到光标处。这个命令的一般格式是`<Ctrl-r>{register}`，其中`{register}`是我们想要插入的寄存器的名字。

2.  这个技巧只适宜插入几个单词，如果寄存器包含了大量的文本，屏幕的更新会有轻微的延时。这时因为vim在插入寄存器的文本时，其插入方式就如同这些文本是由键盘上一个个输进来的。

### 技巧16 在插入模式下做运算

1. `<Ctrl-r>=6*35<CR>` 我们可以用=符号指明使用表达式寄存器。在插入模式中，输入`<Ctrl-r>=`就可以访问这一寄存器。表达式寄存器允许我们做一些运算，并把运算结果直接插入到文档中。

### 技巧19 用替换模式替换已有文本

1. 在替换模式中输入会替换文档中的已有文本，除此之外该模式与插入模式完全相同。

2. 用R命令可以由普通模式进入替换模式，输入`<Insert>`键可以在插入模式和替换模式之间切换。

## 4 可视模式

### 技巧21 选择高亮选区

1. 激活可视模式
    - `v` 切换到面向字符的可视模式
    - `V` 切换到面向行的可视模式
    - `Ctrl-V` 切换到面向列块的可视模式
    - `gv` 重选上次的高亮选区

2. 高亮选区的范围由其两个端点界定。其中一端固定，另一端可以随光标自由移动，我们可以用o键来切换其活动的端点。

### 技巧22 重复执行面向行的可视命令

1. 如果要对某段代码进行多次缩进，可以先缩进一次，然后使用.命令重复。这样更容易进行调整：如果需要再缩进一级，再按一次.即可；如果缩进过深，按u键就可以撤销多余的缩进。

### 技巧23 只要可能，最好用操作符命令，而不是可视命令

1. 在做一系列可重复的修改时，最好用操作符命令，而不是可视命令。

### 技巧24 用面向列块的可视模式编辑表格数据

1. 在列间增加分割线
```
Ctrl-v
3j
r|
```

2. 在行间增加分割线
```
yy
p
Vr-
```

### 技巧25 用面向列块的可视模式同时修改多列

1. 同时修改多列的某个单词
```
Ctrl-v
3je
c(new_word)<Esc>
```

### 技巧26 用面向列块的可视模式在长短不一的高亮块后添加分号

1. 在长短不一的高亮块后添加分号
```
<Ctrl-v>jj$
A;
<Esc>
```

## 5 命令行模式

### 技巧27 结束Vim的命令行模式

1. 在普通模式按下:键时，Vim会切换到命令行模式，在任意时刻，我们都可以按\<Esc\>切换回普通模式。

2. Vim的先祖是vi，正是vi开创了区分模式编辑的范例。而vi的先祖是一个名为ex的行编辑器。出于历史原因，在命令行模式中执行的命令又被称为Ex命令。

3. 查询完整的Ex命令列表：`:h ex-cmd-index`

4. Ex命令操作范围更大，并且能够在一次执行中修改多行。

### 技巧28 在一行或多个连续行上执行命令

1. 用行号作为地址：如果输入一条只包含数字的Ex命令，那么Vim会把这个数字解析成一个地址，并把光标移动到该数字所指定的行上。

2. 用地址指定一个范围：`3,5p`（打印第3行到第5行之间的每一行的内容）

3. 用高亮选区指定范围：按下:后，命令行上会预先填充一个范围:'<,'>，其中‘<. '>分别代表高亮选区的首行和尾行。
```
2G
VG
:
```

4. 用模式指定范围：`:/< html>/,/<\/html>/p` 打印由< html>开标签所在的行开始，到对应闭标签所在的行结束。

5. 用偏移对地址进行修正
    - `:/< html>/+1, /<\/html>/-1p` 打印位于< html>和<\/html>标签之间的行，但不包括标签所在的行。
    - `:., .+3p` 打印当前行开始，向下3行的内容。其中.代表当前行。

### 技巧29 使用`:t`和`:m`命令复制和移动行

1. `:copy`可以把一行或多行从文档的一部分复制到另一部分，`:t`是`:copy`的同义词，你可以把该命令想象为`copy To`

2. `yyp`会使用寄存器，而`:t.`则不会。

3. 在选中高亮选区后，执行`:'<,'>m$`，便把选中的文本移到文件结尾。

### 技巧30 在指定范围上执行普通模式命令
    
1. `:'<,'>normal .` 对高亮选区的每一行执行普通模式的.命令。

2. `:%normal A;` 在文件每行的结尾添加分号。

### 技巧31 重复上次的Ex命令

1. `@:` 或 `Ctrl-o` 均可用于重复上次的Ex命令。

### 技巧32 自动补全Ex命令

1. 常用的自动补全命令
    - `Ctrl-d` 显示可用的补全列表
    - `<Tab>` 或 `<Ctrl-n>` 或 `<Right>` 正向遍历补全列表项
    - `<Shift-Tab>` 或 `<Ctrl-p>` 或 `<Left>` 反向遍历补全列表项

### 技巧33 把当前单词插入到命令行

1. 在vim的命令行下，`<Ctrl-r><Ctrl-w>`会复制光标下的单词并把它插入到命令行中。

2. 在文本中多次修改某个单词（注意：将substitute的查找域留空，表示重用上次的查找模式）
```
/word
cw(new_word)<Esc>
*
:s//<Ctrl-r><Ctrl-w>/g
cw
```

### 技巧34 回溯历史命令

1. `: <Up>`此时最后执行的那条Ex命令会被填充到命令行，再接着按`<Up>`键就可以回到更早的Ex历史命令；按`<Down>`键则会沿相反方向滚动。

2. 输入部分文本后，则只显示与输入内容开头的命令。

3. Vim缺省会记录最后20条命令，可以通过在vimrc文件中加入`set history=200`来修改保存的上限。

4. 命令行窗口
    - `q/`       打开查找命令历史的命令行窗口
    - `q:`       打开Ex命令历史的命令行窗口
    - `<Ctrl-f>` 从命令行模式切换到命令行窗口

### 技巧35 运行shell命令

1. 输入`:!{cmd}` 执行一次性命令

2. 输入`:shell`，在shell中执行几条命令，然后通过`exit`命令返回Vim

3. 输入`<Ctrl-z>` 挂起Vim，然后在shell中执行几条命令，最后通过`fg`唤醒Vim。

4. `:read !{cmd}` 在shell中执行{cmd}，并把其标准输出插入到光标下方。

5. `:[range]write !{cmd}` 在shell中执行{cmd}，以[range]作为其标准输入。

6. `:[range]!{cmd}` 使用shell命令cmd的输出替换[range]。

## 6 管理多个文件

### 技巧36 用缓冲区列表管理打开的文件

1. `:ls` 列出所有被载入内存的缓冲区列表。输出结果中，%符号指明哪个缓冲区在当前窗口中可见，a符号表示它当前是活动缓冲区（active）；而#符号则代表轮换文件，h符号表示它是一个隐藏缓冲区（hidden）。

2. 使用缓冲区列表
    - `:bp[rev]` 或 `:bn[ext]`  切换到下一个/上一个缓冲区
    - `:bfirst` 或 `:blast`     切换到第一个/最后一个缓冲区
    - `:b{N}`                   跳转到第N个缓冲区
    - `:bdelete N1 N2 N3`       根据缓冲区编号来删除缓冲区

### 技巧37 用参数列表将缓冲区分组

1. `:args` 列出参数列表（在启动时作为参数传递给vim的文件列表）

2. `:args {arglist}` 设置参数列表
    
3. :args `cat file`  将file的内容作为参数列表
    
4. `:next` 和 `:prev`  遍历参数列表的文件

5. `:argdo`  在列表中的每个缓冲区执行同一个命令

### 技巧38 管理隐藏缓冲区

1. 在退出时，处理隐藏缓冲区的方式
    - `:w[rite]` 将缓冲区内容写入磁盘
    - `:e[dit]!` 把磁盘文件内容读入缓冲区（即回滚所做修改）
    - `:qa[ll]`  关闭所有窗口，摒弃修改而无需警告
    - `:wa[ll]`  把所有改变的缓冲区写入磁盘

2. 如果修改了某个缓冲区，还没保存就通过`:bnext`切换到下一个缓冲区，vim会弹出一条错误信息，说当前缓冲区有未保存的改动。我们可以通过加上一个叹号`:bnext!`来强制切换。

3. 运行`:argdo`或`:bufdo`前，启用`hidden`设置。这样即使活动缓冲区的内容发生了变化，vim也会在离开该缓冲区时自动将其设为隐藏，而不需要使用叹号来强制这一过程。

### 技巧39 将工作区切分为窗口

在vim术语中，窗口是缓冲区的显示区域。我们既可以打开多个窗口，在这些窗口中显示同一个缓冲区，也可以在每个窗口里载入不同的缓冲区。

1. 创建分割窗口
    - `<Ctrl-w>s` 水平切分此窗口
    - `<Ctrl-w>v` 垂直切分此窗口
    - `sp[lit] {file}` 水平切分当前窗口，并在新窗口中载入{file}
    - `vsp[lit] {file}` 垂直切分当前窗口，并在新窗口中载入{file}

2. 在窗口间切换
    - `<Ctrl-w>w` 在窗口间循环切换
    - `<Ctrl-w>h` 切换到左边的窗口
    - `<Ctrl-w>j` 切换到下边的窗口
    - `<Ctrl-w>k` 切换到上边的窗口
    - `<Ctrl-w>l` 切换到右边的窗口

3. 关闭窗口
    - `:clo[se]`或`<Ctrl-w>c` 关闭活动窗口
    - `:on[ly]`或`<Ctrl-w>o` 只保留活动窗口，关闭其他所有窗口

4. 改变窗口大小及重新排列窗口
    - `<Ctrl-w>=`    使所有窗口等宽、等高
    - `<Ctrl-w>_`    最大化活动窗口的高度
    - `<Ctrl-w>|`    最大化活动窗口的宽度
    - `[N]<Ctrl-w>_` 把活动窗口的高度设为[N]行
    - `[N]<Ctrl-w>|` 把活动窗口的宽度设为[N]列

### 技巧40 用标签页将窗口分组

在vim中，标签页是可以容纳一系列窗口的容器。

1. 打开或关闭标签页
    - `:tabe[dit] file`  在新标签页中打开file
    - `:tabnew`          新建空白标签页
    - `:tabc[lose]`      关闭当前标签页及其中的所有窗口
    - `:tabo[nly]`       只保留当前标签页，关闭所有其他标签页

2. 在标签页间切换
    - `:tabn[ext] {N}` 或 `{N}gt`     切换到编号为{N}的标签页
    - `:tabn[ext]` 或 `gt`            切换到下一个标签页
    * `:tabp[revious]` 或 `gT`        切换到上一个标签页

## 7 打开及保存文件

* 用:e[dit]打开文件
    * :pwd
    打印工作目录
    * :edit %
    %代表活动缓冲区的完整文件路径，按会将其展开
    * :edit %:h
    :h修饰符会去除文件名，但保留路径中的其他部分

* 用:find打开文件
    * 配置path选项
    :set path+=./**
    >注：**通配符会匹配所有子目录

    * :find file
    查找并打开文件file。若存在多个同名文件时，使用Tab切换。

* 用netrw管理文件系统
    * vim dir
    打开文件管理器netrw
    * :e[dit] dir
    打开文件管理器netrw
    * \-
    返回上级目录
    * ENTER
    进入当前目录
    * 杀手级功能
    通过网络来读写文件

## 移动

* 让手指保持在本位行上（ASDFGHJKL所在行）

* 区分实际行和屏幕行
>注：j,k,0,$都用于操作实际行，加上g前缀后则用于操作屏幕行

* 基于单词或字串移动
    *  w b e ge
    基于单词移动
    * W B E gE
    基于字串移动。
    >注：句号及单引号都被当成单词。字串比单词更长。

* 基于查找进行移动
    * d/get
    删除光标处到"get"之前的文本

* 基于文本对象选择选区
    * :h text-objexts
    查看文本对象的帮助信息
    * ci"#
    修改双引号内部的内容为#
    * a) a] a} a> a' a" a`
    选择包括括号或引号在内的文本
    * i) i] i} i> i' i" i`
    选择括号或引号里面的文本
    * at
    选择包括xml标签在内的文本
    * it
    选择标签内部的文本

* 设置位置标记
    * m{a-zA-Z}
    用选定的字母标记当前光标位置
    * 、{mark}
    跳到位置标记所在行的行首
    * 自动位置标记
        * ``
        当前文件中上次跳转动作之前的位置
        * `.
        上次修改的地方
        * `^
        上次插入的地方
        * `[
        上次修改或复制的起始位置
        * `]
        上次修改或复制的结束位置
        * `<
        上次高亮选区的起始位置
        * `>
        上次高亮选区的结束位置

* 在匹配括号间跳转
%
* 在匹配的关键字之间跳转
%
>注：需要激活matchit插件，命令为:h matchit-install

## 寄存器

### 寄存器分类

* 无名寄存器
""
* 复制专用寄存器
"0
* 有名寄存器
"a - "z
* 黑洞寄存器
"_
>注：运行"_d{motion}将删除文本且不保存任何副本

* 系统剪贴板
"+
* 选择专用寄存器
"*
* 表达式寄存器
"=
注：输入一段vim表达式并按Enter执行，如果返回的是字符串，则被存储在表达式寄存器"=中
* 当前文件名
"%
* 轮换文件名
"#
* 上次插入的文本
".
* 上次执行的Ex命令
":
* 上次查找的模式
"/

### 用寄存器进行删除、复制和粘贴

* 调换字符
xp
* 调换文本行
ddp
* 引用寄存器
"{register}
