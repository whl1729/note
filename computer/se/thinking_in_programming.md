# 编程沉思录

## 2020年7月24日

### 论版本发布归档的重要性

昨晚重新测试X1Q产线工具，一直失败。今早发现现在使用的产线工具部分代码与工厂使用的工具貌似不一致，但也不能完全确认。这里暴露出一个问题：自己版本发布归档不规范，导致无法进行重复测试，昨晚加班到10点半，主要原因估计就来源于此。可见，开发流程规范，才能提高效率，减少加班概率。

### 论调试日志的重要性

同样是昨晚测试X1Q产线工具，手动直接调用后端程序可以测试通过。使用前端工具来调用后端程序就测试超时。而且无法看到详细日志，导致无法定位问题。这里同样暴露一个问题：软件开发中，调试日志是无比重要的，是保命之道，发布任何程序时，都应该提供充足的调试手段。

## 2020年6月1日

### bug的一大来源：低估自己改动点的影响范围

前几周APP的同学找我提了一些需求，我在获取媒体列表的接口中增加了三个参数，那个接口原本已经有四个参数，但我认为旧参数与新参数相互独立，没有太多耦合关系，因此基本上只测试新参数，而没测试新参数加上旧参数后的功能。最终由于图片文件的时长计算的一个bug，导致很多参数搭配使用时会出问题。

这个案例，使我再一次意识到：低估自己改动点的影响，是导致bug的一大来源。这个低估，往往来源于惰性，认为全面测试会费时费力，于是便偷懒。这其实和其他工程领域的偷工减料没本质区别，应该引以为戒。

## 2020年5月7日

### 不将就：功能缺陷往往源自设计缺陷

目前C1防碰设置有个问题：APP进行防碰设置时，有时几百毫秒内立即能够返回结果，有时需要五六秒才能返回结果。APP的同学问：防碰设置不是异步响应的吗？为什么有时响应这么慢？

我自然知道其中的原因：处理APP的防碰设置请求时，需要将请求数据通知到AdasMonitor，如果AdasMonitor正在进行防碰设置（如重置算法等），APP的请求数据就会被堵塞。但我一直没意识到这是不合理的：为什么不能做到真正的异步处理呢？接收防碰设置的请求，与进行防碰设置，这两个任务本来就不应该在同一个goroutine中进行。这是不合理的。

所以说，功能缺陷往往源自设计缺陷。当遇到功能缺陷时，应该要有不将就的态度，认真分析其中的不合理之处，修正自己的设计方案。

## linux 沉思录

自己平时主要使用linux系统来开发软件，渐渐体会到linux系统的一些设计哲学，因此记录下来，加以反思。

1. 使用linux系统下的所有工具，都应该先阅读其help文档。

2. 开发linux系统下的所有工具，都应该提供help文档。

## C1 项目沉思录

1. 开发项目时，必须明确项目所有的功能，以及它们之间的约束关系。在开发新功能时，要分析它与所有旧功能的约束关系。

2. 调用底层接口时，需要判断返回值并进行错误处理。同理，消息交互也需要考虑错误处理。

3. 不稳定的功能绝不能上线。（第一次试产停车监控功能受到一片批评）

4. 修改代码后必须重新自验。（重构代码后拍照功能出问题）

5. 一定要确保充足的测试时间。（v1.0.10版本ADAS失效检测功能只测试了一晚就上线，用户升级后发现有问题）

6. 修改代码时需要考虑与其他功能的约束关系。（v1.0.10版本关闭停车监控时忘记修改设置停车监控的代码，导致设置停车监控失败）

7. 修改“打开屏幕”功能引入严重bug，要深刻反思。

8. 定位问题一定要讲究思路，一定要想办法寻找线索。（tar解包速度慢的问题，最终发现是cpu exception导致系统挂死）

9. 分析清楚处理流程再编码，调用底层接口必须明确其约束条件。（GPS校时导致车辆卡死）

10. 接收信号时要确认或检验其可靠性。

11. 开发任何功能都必须自验。（发现自动清理视频封面功能有个删除数据库记录失败的bug，如果做了自验就能避免这个bug）

12. 写shell脚本时要注意工作目录、当前目录、检查执行结果。（发布v1.0.12升级脚本导致主机服务升级失败）

13. 编码时要考虑尽可能多的异常情况，比如：写文件时要考虑对应的目录是否存在。（设备运行后再插入存储卡进行升级会失败）

### 设计接口时要考虑清楚使用场景（被谁使用、什么时候使用、使用时要注意什么）、要健壮

前段时间在重构读写文件的接口时，引入了一个bug：我使用一个全局变量settingMutex指针来保证互斥读写，但在对外接口MutexRead和MutexWrite中直接使用该指针，没有先进行判空处理。导致开机启动时，如果处于缩时录影状态下，需要设置分辨率，进而需要读设备配置文件，而此时settingMutex还没初始化，导致访问空指针。纵观这个问题，根本原因在于设计MutexRead接口的不合理（没考虑到可能未初始化settingsMutex指针就被调用），直接原因是开机启动的处理流程混乱，没有做过良好的设计。

教训是：设计接口时要考虑清楚使用场景，要保证健壮性，做到不管怎么调用都不至于崩溃。
